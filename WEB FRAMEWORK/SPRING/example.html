<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Double Pendulum RK4</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            display: block;
        }
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(30, 30, 30, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            backdrop-filter: blur(5px);
            width: 220px;
        }
        .control-group {
            margin-bottom: 10px;
        }
        label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
            color: #aaa;
        }
        input[type="range"] {
            width: 100%;
            background: transparent;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #4dabf7;
            cursor: pointer;
            margin-top: -5px;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #444;
            border-radius: 2px;
        }
        button {
            width: 100%;
            padding: 8px;
            background: #4dabf7;
            border: none;
            border-radius: 4px;
            color: #121212;
            font-weight: bold;
            cursor: pointer;
            margin-top: 5px;
        }
        button:hover {
            background: #3b8dbf;
        }
    </style>
</head>
<body>

<div id="canvas-container">
    <div id="controls">
        <div class="control-group">
            <label>Mass 1 <span id="val-m1">10</span></label>
            <input type="range" id="m1" min="1" max="40" value="10">
        </div>
        <div class="control-group">
            <label>Mass 2 <span id="val-m2">10</span></label>
            <input type="range" id="m2" min="1" max="40" value="10">
        </div>
        <div class="control-group">
            <label>Length 1 <span id="val-l1">150</span></label>
            <input type="range" id="l1" min="50" max="250" value="150">
        </div>
        <div class="control-group">
            <label>Length 2 <span id="val-l2">150</span></label>
            <input type="range" id="l2" min="50" max="250" value="150">
        </div>
        <div class="control-group">
            <label>Gravity <span id="val-g">9.8</span></label>
            <input type="range" id="g" min="1" max="30" step="0.1" value="9.8">
        </div>
        <button id="reset">Reset Simulation</button>
    </div>
    <canvas id="simCanvas"></canvas>
</div>

<script>
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    let width, height, cx, cy;

    // State: [theta1, omega1, theta2, omega2]
    let state = [Math.PI / 2, 0, Math.PI / 2, 0];
    
    // Params
    let m1 = 10, m2 = 10, l1 = 150, l2 = 150, g = 9.8;
    const dt = 0.05; // Time step for simulation speed

    // Path tracing
    let path = [];
    const maxPath = 200;

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        cx = width / 2;
        cy = height / 3; // Offset origin slightly up
    }
    window.addEventListener('resize', resize);
    resize();

    // UI Bindings
    const inputs = ['m1', 'm2', 'l1', 'l2', 'g'];
    inputs.forEach(id => {
        const el = document.getElementById(id);
        const span = document.getElementById(`val-${id}`);
        el.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            span.textContent = val;
            if (id === 'm1') m1 = val;
            if (id === 'm2') m2 = val;
            if (id === 'l1') l1 = val;
            if (id === 'l2') l2 = val;
            if (id === 'g') g = val;
        });
    });

    document.getElementById('reset').addEventListener('click', () => {
        state = [Math.PI / 2 + Math.random() * 0.5, 0, Math.PI / 2 + Math.random() * 0.5, 0];
        path = [];
        // Clear canvas specifically to remove old trails immediately
        ctx.fillStyle = '#121212';
        ctx.fillRect(0, 0, width, height);
    });

    // Physics: Derivatives calculation for Double Pendulum
    function getDerivatives(s) {
        const [t1, w1, t2, w2] = s;
        
        const num1 = -g * (2 * m1 + m2) * Math.sin(t1);
        const num2 = -m2 * g * Math.sin(t1 - 2 * t2);
        const num3 = -2 * Math.sin(t1 - t2) * m2 * (w2 * w2 * l2 + w1 * w1 * l1 * Math.cos(t1 - t2));
        const den = l1 * (2 * m1 + m2 - m2 * Math.cos(2 * t1 - 2 * t2));
        
        const dw1 = (num1 + num2 + num3) / den;

        const num4 = 2 * Math.sin(t1 - t2);
        const num5 = (w1 * w1 * l1 * (m1 + m2));
        const num6 = g * (m1 + m2) * Math.cos(t1);
        const num7 = w2 * w2 * l2 * m2 * Math.cos(t1 - t2);
        const den2 = l2 * (2 * m1 + m2 - m2 * Math.cos(2 * t1 - 2 * t2));

        const dw2 = (num4 * (num5 + num6 + num7)) / den2;

        return [w1, dw1, w2, dw2];
    }

    // Runge-Kutta 4 Integration
    function rk4(s, dt) {
        const k1 = getDerivatives(s);
        
        const s2 = s.map((v, i) => v + k1[i] * dt * 0.5);
        const k2 = getDerivatives(s2);
        
        const s3 = s.map((v, i) => v + k2[i] * dt * 0.5);
        const k3 = getDerivatives(s3);
        
        const s4 = s.map((v, i) => v + k3[i] * dt);
        const k4 = getDerivatives(s4);

        return s.map((v, i) => v + (dt / 6) * (k1[i] + 2 * k2[i] + 2 * k3[i] + k4[i]));
    }

    function draw() {
        // Fading tail effect
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = 'rgba(18, 18, 18, 0.15)'; // Low opacity for trail
        ctx.fillRect(0, 0, width, height);

        // Calculate Positions
        const x1 = cx + l1 * Math.sin(state[0]);
        const y1 = cy + l1 * Math.cos(state[0]);
        const x2 = x1 + l2 * Math.sin(state[2]);
        const y2 = y1 + l2 * Math.cos(state[2]);

        // Update State
        state = rk4(state, dt);

        // Draw Pendulum Structure
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();

        // Draw Masses
        ctx.fillStyle = '#4dabf7';
        ctx.beginPath();
        ctx.arc(x1, y1, m1/2 + 2, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = '#ff6b6b';
        ctx.beginPath();
        ctx.arc(x2, y2, m2/2 + 2, 0, Math.PI * 2);
        ctx.fill();

        // Store path
        path.push({x: x2, y: y2});
        if (path.length > maxPath) path.shift();

        // Draw Trace (optional extra visibility)
        if (path.length > 1) {
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 107, 107, 0.5)';
            ctx.lineWidth = 1;
            for (let i = 0; i < path.length - 1; i++) {
                ctx.moveTo(path[i].x, path[i].y);
                ctx.lineTo(path[i+1].x, path[i+1].y);
            }
            ctx.stroke();
        }

        requestAnimationFrame(draw);
    }

    draw();
</script>
</body>
</html>